---
layout: default
title: Visibility
permalink: /visibility
---

<div class="vis-wrap">
  <div class="vis-grid">
    <section class="card">
      <h1 class="site-title">Transit Visibility & Ephemerides</h1>
      <p class="muted">Select a planet from the local CSV (same dataset as the Exoplanets page), set your observing site(s), then generate upcoming transits and check visibility.</p>

      <div class="grid2">
        <label>Planet name
          <input id="plName" class="input" list="planetList" placeholder="e.g. WASP-43 b">
          <datalist id="planetList"></datalist>
        </label>
        <div class="row gap">
          <button id="btnLoad" class="btn">Load from local CSV</button>
          <span id="loadStatus" class="muted"></span>
        </div>
      </div>

      <div class="grid3 mt">
        <label>RA (deg)
          <input id="raDeg" class="input" type="number" step="any">
        </label>
        <label>Dec (deg)
          <input id="decDeg" class="input" type="number" step="any">
        </label>
        <label>Epoch T0 (BJD_TDB)
          <input id="t0" class="input" type="number" step="any">
        </label>
        <label>Period (days)
          <input id="period" class="input" type="number" step="any">
        </label>
        <label>Duration (hours)
          <input id="durationHrs" class="input" type="number" step="any">
        </label>
        <label>Epoch system
          <select id="epochSystem" class="input">
            <option value="BJD_TDB" selected>BJD_TDB</option>
            <option value="JD_UTC">JD_UTC</option>
          </select>
        </label>
      </div>
    </section>

    <section class="card">
      <h2>Observing Site(s)</h2>
      <div class="grid4">
        <label>Latitude (deg)
          <input id="latDeg" class="input" type="number" step="any">
        </label>
        <label>Longitude (deg, East +)
          <input id="lonDeg" class="input" type="number" step="any">
        </label>
        <label>Elevation (m)
          <input id="elevM" class="input" type="number">
        </label>
        <label>Min altitude (deg)
          <input id="minAlt" class="input" type="number" value="30">
        </label>
      </div>
      <div class="row gap mt">
        <button id="btnGeo" class="btn ghost">Use my location</button>
        <label class="check"><input id="nightOnly" type="checkbox" checked> Require night (Sun alt ≤ −12°)</label>
      </div>
    </section>

    <section class="card">
      <h2>Ephemerides</h2>
      <div class="grid3">
        <label>From (UTC)
          <input id="fromDate" class="input" type="date">
        </label>
        <label>To (UTC)
          <input id="toDate" class="input" type="date">
        </label>
        <label>Max events
          <input id="maxEvents" class="input" type="number" value="30">
        </label>
      </div>
      <div class="row gap mt">
        <button id="btnEphem" class="btn">Generate ephemerides</button>
        <button id="btnClear" class="btn ghost">Clear</button>
        <button id="btnICS" class="btn ghost">Export selected to .ics</button>
        <span id="ephemStatus" class="muted"></span>
      </div>
      <div id="ephemTableWrap" class="mt table-wrap"></div>
    </section>

    <section class="card">
      <h2>Transit Altitude / Airmass / Parallactic Angle (selected row)</h2>
      <div id="plotAlt" class="plot"></div>
      <div id="plotAir" class="plot small"></div>
      <div id="plotPar" class="plot small"></div>
    </section>
  </div>
</div>

<link rel="preconnect" href="https://cdn.plot.ly">
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
:root{ --accent:#9370DB; }
.site-title{ font-size:1.9rem; color:var(--accent); font-weight:700; }
.vis-wrap{ display:grid; grid-template-columns: 1fr; gap:1rem; }
.card{ background:#fff; border:1px solid #ccc; border-radius:10px; padding:1rem; }
.grid2,.grid3,.grid4{ display:grid; gap:.5rem; }
.grid2{ grid-template-columns:1fr 1fr; }
.grid3{ grid-template-columns:repeat(3,1fr); }
.grid4{ grid-template-columns:repeat(4,1fr); }
.btn{ background:var(--accent); color:#fff; padding:.5rem; border:none; border-radius:5px; }
.btn.ghost{ background:none; color:var(--accent); border:1px solid var(--accent); }
.input{ width:100%; padding:.4rem; border:1px solid #ccc; border-radius:5px; }
.plot{ height:40vh; border:1px solid #ccc; border-radius:5px; margin-bottom:1rem; }
.plot.small{ height:30vh; }
.table-wrap{ overflow:auto; max-height:40vh; }
</style>

<script>
const $=s=>document.querySelector(s);
const canon=s=>(s||'').toString().trim().toLowerCase().replace(/\u2212/g,'-').replace(/[\s]+/g,' ');
const num=v=>(v==null||v==='')?null:(isFinite(+v)?+v:null);
const CSV_URL='/assets/data/pscomppars_recent.csv';
let PLANETS=[];

async function loadCSV(){
  const res=await fetch(CSV_URL); const txt=await res.text();
  const rows=d3.csvParse(txt);
  ['ra','dec','pl_orbper','pl_tranmid','pl_trandur','tran_flag'].forEach(k=>rows.forEach(r=>{ if(r[k]!==undefined){ const v=num(r[k]); if(v!==null) r[k]=v; } }));
  PLANETS=rows;
  const names=Array.from(new Set(rows.map(r=>(typeof r.pl_name==='string'?r.pl_name.trim():''))).values()).filter(n=>n).sort((a,b)=>a.localeCompare(b));
  $('#planetList').innerHTML=names.map(n=>`<option value="${n}">`).join('');
}

function loadFromLocal(name){
  const nm=canon(name); let r=PLANETS.find(p=>canon(p.pl_name)===nm)||PLANETS.find(p=>canon(p.pl_name).replace(/\s+/g,'')===nm.replace(/\s+/g,''));
  if(!r) return;
  $('#plName').value=r.pl_name; if(r.ra!=null)$('#raDeg').value=r.ra; if(r.dec!=null)$('#decDeg').value=r.dec;
  if(r.pl_orbper!=null)$('#period').value=r.pl_orbper; if(r.pl_tranmid!=null)$('#t0').value=r.pl_tranmid; if(r.pl_trandur!=null)$('#durationHrs').value=+r.pl_trandur*24;
}

document.addEventListener('DOMContentLoaded',async()=>{
  await loadCSV();
  $('#plName').value='WASP-43 b'; loadFromLocal('WASP-43 b'); // Default example
  const today=new Date(), to=new Date(Date.now()+30*86400000);
  $('#fromDate').valueAsDate=today; $('#toDate').valueAsDate=to;
  $('#btnLoad').onclick=()=>loadFromLocal($('#plName').value);
});
</script>
