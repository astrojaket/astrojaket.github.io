---
layout: default
title: Visibility
permalink: /visibility
---

<div class="vis-wrap">
  <div class="vis-grid">
    <section class="card">
      <h1 class="site-title">Transit Visibility & Ephemerides</h1>
      <p class="muted">Select a planet from the local CSV (same dataset as the Exoplanets page), set your observing site(s), then generate upcoming transits and check visibility.</p>

      <div class="grid2">
        <label>Planet name
          <input id="plName" class="input" list="planetList" placeholder="e.g. WASP-43 b">
          <datalist id="planetList"></datalist>
        </label>
        <div class="row gap">
          <button id="btnLoad" class="btn">Load from local CSV</button>
          <span id="loadStatus" class="muted"></span>
        </div>
      </div>

      <div class="grid3 mt">
        <label>RA (deg)
          <input id="raDeg" class="input" type="number" step="any" placeholder="e.g. 154.5">
        </label>
        <label>Dec (deg)
          <input id="decDeg" class="input" type="number" step="any" placeholder="e.g. -9.8">
        </label>
        <label>Epoch T0 (BJD_TDB)
          <input id="t0" class="input" type="number" step="any" placeholder="2457000.1234">
        </label>
        <label>Period (days)
          <input id="period" class="input" type="number" step="any" placeholder="0.8135">
        </label>
        <label>Duration (hours)
          <input id="durationHrs" class="input" type="number" step="any" placeholder="1.3">
        </label>
        <label class="tooltip">Epoch system
          <select id="epochSystem" class="input">
            <option value="BJD_TDB" selected>BJD_TDB</option>
            <option value="JD_UTC">JD_UTC (approx)</option>
          </select>
          <span class="tip">pscomppars epochs are commonly BJD_TDB. For display we assume UTC without relativistic corrections.</span>
        </label>
      </div>
    </section>

    <section class="card">
      <h2>Observing Site(s)</h2>
      <div class="grid4">
        <label>Latitude (deg)
          <input id="latDeg" class="input" type="number" step="any" placeholder="e.g. 28.3">
        </label>
        <label>Longitude (deg, East +)
          <input id="lonDeg" class="input" type="number" step="any" placeholder="e.g. -16.5">
        </label>
        <label>Elevation (m)
          <input id="elevM" class="input" type="number" step="1" placeholder="0">
        </label>
        <label>Min altitude (deg)
          <input id="minAlt" class="input" type="number" step="any" value="30">
        </label>
      </div>
      <div class="row gap mt">
        <button id="btnGeo" class="btn ghost">Use my location</button>
        <label class="check"><input id="nightOnly" type="checkbox" checked> Require night (Sun alt ≤ −12° at some point)</label>
      </div>
      <details class="mt">
        <summary class="muted">Add a second site (optional)</summary>
        <div class="grid4 mt">
          <label>Lat2 (deg)
            <input id="latDeg2" class="input" type="number" step="any">
          </label>
          <label>Lon2 (deg, East +)
            <input id="lonDeg2" class="input" type="number" step="any">
          </label>
          <label>Elev2 (m)
            <input id="elevM2" class="input" type="number" step="1">
          </label>
          <label>Min alt 2 (deg)
            <input id="minAlt2" class="input" type="number" step="any" placeholder="30">
          </label>
        </div>
      </details>
    </section>

    <section class="card">
      <h2>Ephemerides</h2>
      <div class="grid3">
        <label>From (UTC)
          <input id="fromDate" class="input" type="date">
        </label>
        <label>To (UTC)
          <input id="toDate" class="input" type="date">
        </label>
        <label>Max events
          <input id="maxEvents" class="input" type="number" value="30" min="1" max="500">
        </label>
      </div>
      <div class="row gap mt">
        <button id="btnEphem" class="btn">Generate ephemerides</button>
        <button id="btnClear" class="btn ghost">Clear</button>
        <button id="btnICS" class="btn ghost">Export selected to .ics</button>
        <span id="ephemStatus" class="muted"></span>
      </div>
      <div id="ephemTableWrap" class="mt table-wrap"></div>
    </section>

    <section class="card">
      <h2>Transit Altitude / Airmass / Parallactic Angle (selected row)</h2>
      <div id="plotAlt" class="plot"></div>
      <div id="plotAir" class="plot small"></div>
      <div id="plotPar" class="plot small"></div>
      <div class="muted">Click a row in the table to plot; shaded region shows ±1 transit duration.</div>
    </section>

    <section class="card">
      <h2>Notes & Sources</h2>
      <ul class="notes">
        <li>Planet parameters loaded from <code>/assets/data/pscomppars_recent.csv</code> (NASA Exoplanet Archive).</li>
        <li>GMST and sidereal-time transform: simple polynomial adequate for planning.</li>
        <li>Solar position: low-order approximation of ecliptic longitude/equation of time; good to a few arcminutes.</li>
        <li>Airmass: Kasten &amp; Young (1989) optical airmass formula; clamp at low altitude to avoid divergence.</li>
        <li>Parallactic angle: standard spherical-trigonometry expression using hour angle, site latitude, target declination.</li>
        <li>Time systems: epochs usually BJD_TDB in archive; here we display UTC; for high precision, confirm with observatory tools.</li>
      </ul>
    </section>
  </div>
</div>

<link rel="preconnect" href="https://cdn.plot.ly">
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
:root{ --accent:#9370DB; --border:#e5e7eb; --muted:#6b7280; }
.site-title{ font-size:1.9rem; color:var(--accent); font-weight:700; letter-spacing:.1px; margin:0 0 .25rem 0; }
.vis-wrap{ display:grid; grid-template-columns: 1fr; gap:1rem; }
.vis-grid{ display:grid; gap:1rem; }
.card{ background:#fff; border:1px solid var(--border); border-radius:16px; padding:1rem; box-shadow:0 1px 2px rgba(0,0,0,.05); }
.grid2{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:.6rem; align-items:end; }
.grid3{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:.6rem; }
.grid4{ display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:.6rem; }
.row.gap{ display:flex; gap:.6rem; align-items:center; }
.mt{ margin-top:.6rem; }
.muted{ color:var(--muted); font-size:.9rem; }
.input{ width:100%; padding:.5rem .65rem; border:1px solid #d1d5db; border-radius:10px; }
.btn{ background:var(--accent); color:#fff; border:none; border-radius:10px; padding:.55rem .8rem; cursor:pointer; }
.btn.ghost{ background:transparent; color:var(--accent); border:1px solid var(--accent); }
.plot{ height:48vh; border:1px solid var(--border); border-radius:16px; margin-bottom:.6rem; }
.plot.small{ height:32vh; }
.table-wrap{ overflow:auto; max-height:45vh; border:1px solid var(--border); border-radius:12px; }
table{ width:100%; border-collapse:collapse; font-size:.95rem; }
th, td{ padding:.4rem .5rem; border-bottom:1px solid #eee; }
tr:hover{ background:#fafafa; cursor:pointer; }
tr.selected{ background:#ede7fb; }
.check{ display:inline-flex; align-items:center; gap:.4rem; }
.tooltip{ position:relative; }
.tooltip .tip{ position:absolute; left:0; top:100%; transform:translateY(4px); background:#111; color:#fff; padding:.3rem .5rem; border-radius:6px; font-size:.8rem; display:none; }
.tooltip:hover .tip{ display:block; }
@media (max-width:1100px){ .grid3{ grid-template-columns:1fr; } .grid4{ grid-template-columns:1fr; } }
</style>

<script>
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const num = v => (v==null || v==='') ? null : (isFinite(+v) ? +v : null);
// Normalize names: lowercase, trim, collapse spaces, convert NBSP, convert all dashes to '-'
const canon = s => (s||'')
  .toString()
  .trim()
  .toLowerCase()
  .replace(/[\\u00a0]/g,' ')
  .replace(/[\\u2010\\u2011\\u2012\\u2013\\u2014\\u2212]/g,'-')
  .replace(/[\\s]+/g,' ');

const CSV_URL = '/assets/data/pscomppars_recent.csv';
let PLANETS = [];

// Data load
async function loadCSV(){
  const res = await fetch(CSV_URL, {mode:'cors'});
  if(!res.ok){ document.getElementById('loadStatus').textContent = 'Failed to fetch local CSV.'; return; }
  const txt = await res.text();
  const rows = d3.csvParse(txt);
  const numCols = ['ra','dec','pl_orbper','pl_tranmid','pl_trandur','tran_flag'];
  for(const r of rows){ for(const k of numCols){ if(r[k] !== undefined){ const v=num(r[k]); if(v!==null) r[k]=v; } } }
  PLANETS = rows;
  const names = Array.from(new Set(rows.map(r => (typeof r.pl_name==='string'? r.pl_name.trim() : '')).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  document.getElementById('planetList').innerHTML = names.map(n => `<option value="${n}">`).join('');
  document.getElementById('loadStatus').textContent = `Loaded local CSV (${rows.length.toLocaleString()} rows)`;
}

// Build a lookup map on demand using multiple keys per planet
function getNameIndex(){
  if(getNameIndex._idx) return getNameIndex._idx;
  const idx = new Map();
  for(const p of PLANETS){
    const c = canon(p.pl_name);
    if(!c) continue;
    const k1 = c;
    const k2 = c.replace(/\\s+/g,'');
    const k3 = c.replace(/[\\s-]+/g,'');
    if(!idx.has(k1)) idx.set(k1, p);
    if(!idx.has(k2)) idx.set(k2, p);
    if(!idx.has(k3)) idx.set(k3, p);
  }
  getNameIndex._idx = idx;
  return idx;
}

function loadFromLocal(name){
  const nm = canon(name);
  if(!nm){ document.getElementById('loadStatus').textContent = 'Enter a planet name.'; return; }
  const idx = getNameIndex();
  const r = idx.get(nm) || idx.get(nm.replace(/\\s+/g,'')) || idx.get(nm.replace(/[\\s-]+/g,''));
  if(!r){ document.getElementById('loadStatus').textContent = 'No match in CSV. Try the list.'; return; }

  document.getElementById('plName').value = r.pl_name || name;
  if(r.ra!=null) document.getElementById('raDeg').value = r.ra;
  if(r.dec!=null) document.getElementById('decDeg').value = r.dec;
  if(r.pl_orbper!=null) document.getElementById('period').value = r.pl_orbper;
  if(r.pl_tranmid!=null) document.getElementById('t0').value = r.pl_tranmid;
  if(r.pl_trandur!=null) document.getElementById('durationHrs').value = (+r.pl_trandur)*24;
  document.getElementById('loadStatus').textContent = (r.tran_flag===1? 'Loaded from local CSV.' : 'Loaded (not flagged as transiting).');
}

// Time & astro helpers
function toJD(date){ return date.getTime()/86400000 + 2440587.5; }
function gmst(jd){
  const T = (jd - 2451545.0)/36525.0;
  let g = 280.46061837 + 360.98564736629*(jd-2451545.0) + 0.000387933*T*T - T*T*T/38710000.0;
  g = (g%360+360)%360;
  return g*Math.PI/180;
}
function altAz(jd, raDeg, decDeg, latDeg, lonDeg){
  const ra = raDeg*Math.PI/180, dec = decDeg*Math.PI/180;
  const lat = latDeg*Math.PI/180, lon = lonDeg*Math.PI/180;
  const lst = gmst(jd) + lon;
  const H = lst - ra;
  const sinAlt = Math.sin(lat)*Math.sin(dec) + Math.cos(lat)*Math.cos(dec)*Math.cos(H);
  const alt = Math.asin(Math.max(-1,Math.min(1,sinAlt)));
  const cosAz = (Math.sin(dec) - Math.sin(alt)*Math.sin(lat)) / (Math.cos(alt)*Math.cos(lat));
  let az = Math.acos(Math.max(-1,Math.min(1,cosAz)));
  if(Math.sin(H)>0) az = 2*Math.PI - az;
  return { altDeg: alt*180/Math.PI, azDeg: az*180/Math.PI, H };
}
function sunRaDec(jd){
  const n = jd - 2451545.0;
  let L = (280.460 + 0.9856474*n) % 360; if(L<0)L+=360;
  let g = (357.528 + 0.9856003*n) * Math.PI/180;
  const lam = (L + 1.915*Math.sin(g) + 0.020*Math.sin(2*g)) * Math.PI/180;
  const eps = (23.439 - 0.0000004*n) * Math.PI/180;
  const ra = Math.atan2(Math.cos(eps)*Math.sin(lam), Math.cos(lam));
  const dec = Math.asin(Math.sin(eps)*Math.sin(lam));
  return { ra: (ra+2*Math.PI)%(2*Math.PI), dec };
}
function sunAlt(jd, latDeg, lonDeg){
  const s = sunRaDec(jd);
  const a = altAz(jd, s.ra*180/Math.PI, s.dec*180/Math.PI, latDeg, lonDeg);
  return a.altDeg;
}
function airmassKastenYoung(altDeg){
  const z = (90 - altDeg) * Math.PI/180;
  return 1/(Math.cos(z) + 0.50572 * Math.pow(96.07995 - (z*180/Math.PI), -1.6364));
}
function parallacticAngle(H, latDeg, decDeg){
  const phi = latDeg*Math.PI/180;
  const delta = decDeg*Math.PI/180;
  const sinq = Math.sin(H) * Math.cos(phi);
  const cosq = Math.cos(phi)*Math.tan(delta) - Math.sin(phi)*Math.cos(H);
  return Math.atan2(sinq, cosq) * 180/Math.PI;
}

// Ephemerides
function generateEphemerides(t0, period, fromJD, toJD, maxN){
  if(t0==null || period==null) return [];
  const events = [];
  let k = Math.ceil((fromJD - t0)/period);
  if(!isFinite(k)) k = 0;
  for(let i=0; i<maxN; i++){
    const t = t0 + (k+i)*period;
    if(t > toJD) break;
    events.push({ midJD: t, idx: k+i });
  }
  return events;
}
function jdToISO(jd){ const ms=(jd-2440587.5)*86400000; return new Date(ms).toISOString().replace('.000',''); }
function jdToLocal(jd){ const ms=(jd-2440587.5)*86400000; return new Date(ms).toLocaleString(); }

function buildTable(rows, planet, site, site2){
  const wrap = document.getElementById('ephemTableWrap');
  if(!rows.length){ wrap.innerHTML = '<p class="muted">No events in range.</p>'; return; }
  let html = '<table><thead><tr><th>#</th><th>Mid (UTC)</th><th>Mid (Local)</th><th>Mid (JD)</th><th>Max Alt</th><th>Visible?</th>';
  if(site2) html += '<th>Max Alt 2</th><th>Visible 2?</th>';
  html += '</tr></thead><tbody>';
  for(const r of rows){
    html += `<tr data-jd="${r.midJD}" data-ra="${planet.ra}" data-dec="${planet.dec}" data-lat="${site.lat}" data-lon="${site.lon}" data-dur="${planet.dur}"` + (site2? ` data-lat2="${site2.lat}" data-lon2="${site2.lon}"`:'') + `>` +
      `<td>${r.idx}</td><td>${jdToISO(r.midJD)}</td><td>${jdToLocal(r.midJD)}</td><td>${r.midJD.toFixed(5)}</td>`+
      `<td>${(r.maxAlt ?? NaN).toFixed(1)}°</td><td>${r.visible?'Yes':'No'}</td>` +
      (site2? `<td>${(r.maxAlt2 ?? NaN).toFixed(1)}°</td><td>${r.visible2?'Yes':'No'}</td>`:'') +
      `</tr>`;
  }
  html += '</tbody></table>';
  wrap.innerHTML = html;

  wrap.querySelectorAll('tbody tr').forEach(tr => tr.addEventListener('click', () => {
    wrap.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
    tr.classList.add('selected');
    const jd = +tr.getAttribute('data-jd');
    // Reset then plot
    Plotly.purge('plotAlt'); Plotly.purge('plotAir'); Plotly.purge('plotPar');
    plotTransit(jd, +tr.dataset.ra, +tr.dataset.dec, +tr.dataset.lat, +tr.dataset.lon, +tr.dataset.dur, +(document.getElementById('minAlt').value));
  }));
}

function plotTransit(midJD, ra, dec, lat, lon, durHrs, minAlt){
  const n = 121;
  const halfDays = (isFinite(durHrs) ? (durHrs/2)/24 : 0.05);
  const pad = Math.max(halfDays, 0.05);
  const t1 = midJD - pad, t2 = midJD + pad;
  const xs = [], alts = [], airs = [], pars = [], sunAlts = [];
  for(let i=0;i<n;i++){
    const jd = t1 + (i/(n-1))*(t2 - t1);
    const a = altAz(jd, ra, dec, lat, lon);
    xs.push(new Date((jd - 2440587.5)*86400000));
    const alt = a.altDeg;
    alts.push(alt);
    airs.push( airmassKastenYoung(Math.max(5, alt)) );
    pars.push( parallacticAngle(a.H, lat, dec) );
    sunAlts.push( sunAlt(jd, lat, lon) );
  }
  const minAltArr = new Array(n).fill(minAlt);
  Plotly.react('plotAlt', [
    {type:'scatter', mode:'lines', x:xs, y:alts, name:'Altitude (deg)'},
    {type:'scatter', mode:'lines', x:xs, y:minAltArr, name:'Min Alt', line:{dash:'dash'}},
    {type:'scatter', mode:'lines', x:xs, y:sunAlts, name:'Sun Alt (deg)', line:{dash:'dot'}}
  ], {margin:{l:50,r:10,t:10,b:40}, xaxis:{title:'Time (UTC)'}, yaxis:{title:'Altitude (deg)'}, showlegend:true}, {displaylogo:false, responsive:true});

  Plotly.react('plotAir', [{type:'scatter', mode:'lines', x:xs, y:airs, name:'Airmass'}],
    {margin:{l:50,r:10,t:10,b:40}, xaxis:{title:'Time (UTC)'}, yaxis:{title:'Airmass'}}, {displaylogo:false, responsive:true});

  Plotly.react('plotPar', [{type:'scatter', mode:'lines', x:xs, y:pars, name:'Parallactic Angle'}],
    {margin:{l:50,r:10,t:10,b:40}, xaxis:{title:'Time (UTC)'}, yaxis:{title:'Parallactic Angle (deg)'}}, {displaylogo:false, responsive:true});
}

function onEphemerides(){
  const ra = num(document.getElementById('raDeg').value), dec = num(document.getElementById('decDeg').value);
  const period = num(document.getElementById('period').value), t0 = num(document.getElementById('t0').value);
  const dur = num(document.getElementById('durationHrs').value);
  const lat = num(document.getElementById('latDeg').value), lon = num(document.getElementById('lonDeg').value);
  const minAlt = num(document.getElementById('minAlt').value) ?? 30;
  const nightOnly = document.getElementById('nightOnly').checked;
  const maxEvents = Math.max(1, Math.min(500, +(document.getElementById('maxEvents').value)||30));
  const lat2 = num(document.getElementById('latDeg2').value), lon2 = num(document.getElementById('lonDeg2').value);
  const minAlt2 = num(document.getElementById('minAlt2').value) ?? minAlt;
  const hasSite2 = isFinite(lat2) && isFinite(lon2);
  if([ra,dec,period,t0,lat,lon].some(v=>v==null)){
    document.getElementById('ephemStatus').textContent = 'Provide RA, Dec, Period, T0, Latitude, Longitude.'; return;
  }

  const from = document.getElementById('fromDate').value ? new Date(document.getElementById('fromDate').value+'T00:00:00Z') : new Date();
  const to = document.getElementById('toDate').value ? new Date(document.getElementById('toDate').value+'T23:59:59Z') : new Date(Date.now()+30*86400000);
  const fromJD = toJD(from), toJDv = toJD(to);

  const events = generateEphemerides(t0, period, fromJD, toJDv, maxEvents);
  for(const ev of events){
    const halfDays = (isFinite(dur) ? (dur/2)/24 : 0.05);
    const t1 = ev.midJD - halfDays, t2 = ev.midJD + halfDays;
    let maxAlt = -90, seen = false, nightSeen = !nightOnly;
    let maxAlt2 = -90, seen2 = false, nightSeen2 = !nightOnly;
    for(let i=0;i<31;i++){
      const jd = t1 + (i/30)*(t2 - t1);
      const a1 = altAz(jd, ra, dec, lat, lon).altDeg;
      if(a1 > maxAlt) maxAlt = a1;
      if(a1 >= minAlt) seen = true;
      if(nightOnly && sunAlt(jd, lat, lon) <= -12) nightSeen = true;
      if(hasSite2){
        const a2 = altAz(jd, ra, dec, lat2, lon2).altDeg;
        if(a2 > maxAlt2) maxAlt2 = a2;
        if(a2 >= minAlt2) seen2 = true;
        if(nightOnly && sunAlt(jd, lat2, lon2) <= -12) nightSeen2 = true;
      }
    }
    ev.maxAlt = maxAlt; ev.visible = seen && nightSeen;
    if(hasSite2){ ev.maxAlt2 = maxAlt2; ev.visible2 = seen2 && nightSeen2; }
  }
  buildTable(events, {ra,dec,dur}, {lat,lon}, hasSite2?{lat:lat2,lon:lon2}:null);
  document.getElementById('ephemStatus').textContent = `Generated ${events.length} event(s). Click a row to plot.`;
}

function exportICS(){
  const tr = document.querySelector('#ephemTableWrap tr.selected');
  if(!tr){ alert('Select a row first.'); return; }
  const name = document.getElementById('plName').value || 'Exoplanet Transit';
  const jd = +tr.getAttribute('data-jd');
  const dur = Math.max(0.5, num(document.getElementById('durationHrs').value) || 2.0);
  const startMs = (jd - 2440587.5)*86400000 - (dur/2)*3600000;
  const endMs = (jd - 2440587.5)*86400000 + (dur/2)*3600000;
  const dtStart = new Date(startMs).toISOString().replace(/[-:]/g,'').replace('.000','');
  const dtEnd = new Date(endMs).toISOString().replace(/[-:]/g,'').replace('.000','');
  const ics = [
    'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//astrojake.com//Visibility//EN','BEGIN:VEVENT',
    `UID:${Date.now()}@astrojake.com`,`DTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').replace('.000','')}`,
    `DTSTART:${dtStart}`,`DTEND:${dtEnd}`,`SUMMARY:${name} transit`,'END:VEVENT','END:VCALENDAR'
  ].join('\r\n');
  const blob = new Blob([ics], {type:'text/calendar;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${name.replace(/\s+/g,'_')}_transit.ics`; document.body.appendChild(a); a.click(); a.remove();
}

function useMyLocation(){
  if(!navigator.geolocation){ alert('Geolocation not available'); return; }
  navigator.geolocation.getCurrentPosition(pos => {
    document.getElementById('latDeg').value = pos.coords.latitude.toFixed(5);
    document.getElementById('lonDeg').value = pos.coords.longitude.toFixed(5);
    document.getElementById('elevM').value = Math.round(pos.coords.altitude || 0);
  }, err => alert('Location failed: '+err.message), {enableHighAccuracy:true, timeout:8000});
}

document.addEventListener('DOMContentLoaded', async () => {
  const today = new Date();
  const to = new Date(Date.now() + 30*86400000);
  document.getElementById('fromDate').valueAsDate = today;
  document.getElementById('toDate').valueAsDate = to;

  await loadCSV();
  document.getElementById('plName').value = 'WASP-43 b';
  loadFromLocal('WASP-43 b');

  document.getElementById('btnLoad').addEventListener('click', () => loadFromLocal(document.getElementById('plName').value));
  document.getElementById('btnGeo').addEventListener('click', useMyLocation);
  document.getElementById('btnEphem').addEventListener('click', onEphemerides);
  document.getElementById('btnClear').addEventListener('click', () => {
    document.getElementById('ephemTableWrap').innerHTML='';
    document.getElementById('ephemStatus').textContent='';
    Plotly.purge('plotAlt'); Plotly.purge('plotAir'); Plotly.purge('plotPar');
  });
  document.getElementById('btnICS').addEventListener('click', exportICS);
  document.getElementById('plName').addEventListener('change', (e)=> { if(e.target.value) loadFromLocal(e.target.value); });
});
</script>
