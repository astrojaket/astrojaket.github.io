---
layout: default
title: Exoplanets
permalink: /exoplanets
---

<div id="exo-explorer" class="exo-container">
  <div class="exo-topbar">
    <div class="exo-controls">
      <div class="exo-card">
        <h2>Axes</h2>
        <div class="exo-grid2">
          <label>X axis
            <select id="xSelect" class="exo-input"></select>
          </label>
          <label>Y axis
            <select id="ySelect" class="exo-input"></select>
          </label>
          <label class="exo-check"><input id="xLog" type="checkbox"/> Log X</label>
          <label class="exo-check"><input id="yLog" type="checkbox"/> Log Y</label>
          <label class="exo-check"><input id="colorTemp" type="checkbox"/> Color by Teq (K)</label>
          <label class="exo-check"><input id="onlyTransiting" type="checkbox"/> Only transiting</label>
          <label class="exo-check"><input id="showLabels" type="checkbox"/> Show labels (all)</label>
        </div>
      </div>

      <div class="exo-card">
        <h2>Filters</h2>
        <div class="exo-grid4 exo-filters">
          <div><div class="exo-filter-label">Best Mass (M⊕)</div>
            <input id="f-min-pl_bmasse" class="exo-input" type="number" step="any" placeholder="min" />
            <input id="f-max-pl_bmasse" class="exo-input" type="number" step="any" placeholder="max" />
          </div>
          <div><div class="exo-filter-label">Best Mass (MJ)</div>
            <input id="f-min-pl_bmassj" class="exo-input" type="number" step="any" placeholder="min" />
            <input id="f-max-pl_bmassj" class="exo-input" type="number" step="any" placeholder="max" />
          </div>
          <div><div class="exo-filter-label">Radius (R⊕)</div>
            <input id="f-min-pl_rade" class="exo-input" type="number" step="any" placeholder="min" />
            <input id="f-max-pl_rade" class="exo-input" type="number" step="any" placeholder="max" />
          </div>
          <div><div class="exo-filter-label">Radius (RJ)</div>
            <input id="f-min-pl_radj" class="exo-input" type="number" step="any" placeholder="min" />
            <input id="f-max-pl_radj" class="exo-input" type="number" step="any" placeholder="max" />
          </div>
          <div><div class="exo-filter-label">Period (days)</div>
            <input id="f-min-pl_orbper" class="exo-input" type="number" step="any" placeholder="min" />
            <input id="f-max-pl_orbper" class="exo-input" type="number" step="any" placeholder="max" />
          </div>
          <div><div class="exo-filter-label">Stellar Age (Gyr)</div>
            <input id="f-min-st_age" class="exo-input" type="number" step="any" placeholder="min" />
            <input id="f-max-st_age" class="exo-input" type="number" step="any" placeholder="max" />
          </div>
          <div><div class="exo-filter-label">Stellar Radius (R☉)</div>
            <input id="f-min-st_rad" class="exo-input" type="number" step="any" placeholder="min" />
            <input id="f-max-st_rad" class="exo-input" type="number" step="any" placeholder="max" />
          </div>
          <div><div class="exo-filter-label">Equilibrium T (K)</div>
            <input id="f-min-pl_eqt" class="exo-input" type="number" step="any" placeholder="min" />
            <input id="f-max-pl_eqt" class="exo-input" type="number" step="any" placeholder="max" />
          </div>
        </div>
        <div class="exo-row gap">
          <button id="applyFilters" class="exo-btn">Update</button>
          <button id="clearFilters" class="exo-btn ghost">Clear</button>
        </div>
      </div>

      <div class="exo-card">
        <h2>Highlights</h2>
        <label class="exo-check"><input id="highlightJWSTObs" type="checkbox" checked/> JWST – Observed (diamond)</label>
        <label class="exo-check"><input id="highlightJWSTPlan" type="checkbox" checked/> JWST – Planned (diamond)</label>
      </div>
    </div>

    <aside class="exo-card exo-presets">
      <h2>Presets</h2>
      <div class="exo-chiprow">
        <span class="exo-chip sep">Kempton+18 bins</span>
        <button class="exo-chip" data-preset="k18-rocky">&lt;1.5 R⊕</button>
        <button class="exo-chip" data-preset="k18-small">1.5–2.75 R⊕</button>
        <button class="exo-chip" data-preset="k18-subn">2.75–4.0 R⊕</button>
        <button class="exo-chip" data-preset="k18-giant">&gt;4 R⊕</button>
      </div>
      <div class="exo-chiprow">
        <span class="exo-chip sep">Popular</span>
        <button class="exo-chip" data-preset="hotjup">Hot Jupiters</button>
        <button class="exo-chip" data-preset="subnep">Sub‑Neptunes</button>
      </div>
    </aside>
  </div>

  <div class="exo-main">
    <div id="plot" class="exo-plot"></div>
    <aside class="exo-card">
      <h3>Legend</h3>
      <ul class="exo-legend">
        <li><span class="dot pop"></span> Population</li>
        <li><span class="dot jwstobs" style="border:1px solid #4b3a8f">◆</span> JWST – Observed</li>
        <li><span class="dot jwstplan" style="border:1px solid #034d57">◆</span> JWST – Planned</li>
      </ul>
      <div id="counts" class="exo-note">—</div>
      <hr/>
      <div class="exo-note">
        CSVs: <code>/assets/data/pscomppars_recent.csv</code>, <code>/assets/data/jwst_trexolists_extended.csv</code>
      </div>
      <div id="status" class="exo-note">Loading population…</div>
    </aside>
  </div>
</div>

<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
:root { --mpurple:#9370DB; --mpurple-600:#7a5fd5; --muted:#6b7280; }
.exo-container { display:grid; gap:1rem; }
.exo-topbar { display:grid; grid-template-columns:1fr 300px; gap:1rem; }
.exo-controls { display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:1rem; }
.exo-main { display:grid; grid-template-columns:1fr 300px; gap:1rem; }
.exo-card { background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:1rem; box-shadow:0 1px 2px rgba(0,0,0,.05); }
.exo-plot { height:70vh; border:1px solid #e5e7eb; border-radius:16px; }
.exo-input { width:100%; padding:.45rem .6rem; border:1px solid #d1d5db; border-radius:10px; }
.exo-btn { padding:.55rem .8rem; border-radius:10px; border:none; color:#fff; background:var(--mpurple); cursor:pointer; }
.exo-btn.ghost { background:transparent; color:var(--mpurple); border:1px solid var(--mpurple-600); }
.exo-check { display:inline-flex; align-items:center; gap:.4rem; margin-right:.6rem; }
.exo-legend { list-style:none; padding:0; margin:.5rem 0; }
.dot { display:inline-block; width:10px; height:10px; border-radius:4px; margin-right:.4rem; color:#555; }
.dot.pop { background:#9CA3AF; opacity:.8; }
.dot.jwstobs { background:var(--mpurple); }
.dot.jwstplan { background:#06b6d4; }
.exo-grid2 { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:.6rem; }
.exo-grid4 { display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:.6rem; }
.exo-chiprow { display:flex; flex-wrap:wrap; gap:.4rem; margin:.3rem 0; }
.exo-chip { background:#f3f0ff; border:1px solid #e1d7ff; color:#4b3a8f; padding:.25rem .5rem; border-radius:999px; font-size:.85rem; cursor:pointer; }
.exo-chip.sep { background:transparent; border:0; color:#6b7280; cursor:default; font-weight:600; }
@media(max-width:1100px){ .exo-controls{grid-template-columns:1fr;} .exo-topbar{grid-template-columns:1fr;} .exo-main{grid-template-columns:1fr;} }
</style>

<script>
const POP_CSV = '/assets/data/pscomppars_recent.csv';
const JWST_CSV = '/assets/data/jwst_trexolists_extended.csv';

const columns = ['pl_name','hostname','pl_bmasse','pl_bmassj','pl_rade','pl_radj','pl_orbper','st_age','st_rad','pl_eqt','tran_flag'];

const PARAMS = {
  'Best Planet Mass (M_⊕)': d => num(d.pl_bmasse),
  'Best Planet Mass (M_J)': d => num(d.pl_bmassj),
  'Planet Radius (R_⊕)': d => num(d.pl_rade),
  'Planet Radius (R_J)': d => num(d.pl_radj),
  'Orbital Period (days)': d => num(d.pl_orbper),
  'Stellar Age (Gyr)': d => num(d.st_age),
  'Stellar Radius (R_☉)': d => num(d.st_rad),
  'Equilibrium Temperature (K)': d => num(d.pl_eqt),
};

const PRESETS = {
  'k18-rocky': { pl_rade: [null, 1.5] },
  'k18-small': { pl_rade: [1.5, 2.75] },
  'k18-subn':  { pl_rade: [2.75, 4.0] },
  'k18-giant': { pl_rade: [4.0, null] },
  'hotjup': { pl_rade: [8, null], pl_eqt: [1000, null] },
  'subnep': { pl_rade: [2, 4] },
};

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const num = v => (v==null||v===''?null:(isFinite(+v)?+v:null));
const canon = s => (s||'').toString().trim().toLowerCase()
  .replace(/\u2212/g,'-') // unicode minus
  .replace(/\s+/g,' ')    // collapse spaces
  ;
const alphanum = s => canon(s).replace(/[^a-z0-9]/g,'');

// Normalize a planet name to multiple keys for robust matching
function nameKeys(star, letter){
  const s = canon(star||'');
  const L = canon(letter||'');
  const withSpace = (s && L) ? `${s} ${L}` : (s||L);
  const noSpace = (s+L).trim();
  return new Set([withSpace, noSpace, alphanum(withSpace), alphanum(noSpace)]);
}

const state = {
  all: [], rows: [],
  jwstObserved: new Set(), jwstPlanned: new Set(),
  jwstKeys: new Set(), // all canonical keys
  filters: {}
};

function csvParseLoose(text){
  const cleaned = text.split(/\n/).filter(l=>!/^\s*#/.test(l)).join('\n');
  return d3.csvParse(cleaned);
}

async function loadCSV(url){
  const res = await fetch(url, {mode:'cors'});
  if(!res.ok) throw new Error('Fetch failed '+url+' '+res.status);
  const txt = await res.text();
  return csvParseLoose(txt);
}

async function loadPopulation(){
  const rows = await loadCSV(POP_CSV);
  for(const r of rows){
    for(const k of ['pl_bmasse','pl_bmassj','pl_rade','pl_radj','pl_orbper','st_age','st_rad','pl_eqt']) r[k]=num(r[k]);
    r.tran_flag = num(r.tran_flag);
    r._nameKeys = nameKeys(r.hostname, (r.pl_name||'').split(' ').slice(-1)[0]); // last token often the letter
    r._plCanon = canon(r.pl_name);
    r._plAlpha = alphanum(r.pl_name);
  }
  return rows;
}

async function loadJWST(){
  try{
    const rows = await loadCSV(JWST_CSV);
    const obs = new Set(), plan = new Set(), allKeys = new Set();
    const PLANNED = new Set(['Scheduled','Implementation','Flight Ready','Inactive','On Hold','On Hold (Inactive)']);
    for(const r of rows){
      const keys = nameKeys(r['Star   name']||r['Star name']||r['Star'], r['Planet   letter']||r['Planet letter']||r['Planet']);
      keys.forEach(k=>allKeys.add(k));
      const status = (r['Status']||'').trim();
      if(status==='Executed') keys.forEach(k=>obs.add(k));
      else if(PLANNED.has(status)) keys.forEach(k=>plan.add(k));
    }
    state.jwstObserved = obs; state.jwstPlanned = plan; state.jwstKeys = allKeys;
    $('#status').textContent += ` | JWST loaded (Obs: ${obs.size/4|0}, Plan: ${plan.size/4|0})`;
    refresh();
  }catch(e){
    console.warn('JWST load failed', e);
  }
}

function populateDropdowns(){
  const xSel = $('#xSelect'), ySel = $('#ySelect');
  const opts = Object.keys(PARAMS).map(l=>`<option>${l}</option>`).join('');
  xSel.innerHTML = ySel.innerHTML = opts;
  xSel.value = 'Orbital Period (days)';
  ySel.value = 'Planet Radius (R_⊕)';
}

function collectFilters(){
  const keys=['pl_bmasse','pl_bmassj','pl_rade','pl_radj','pl_orbper','st_age','st_rad','pl_eqt'];
  const f={}; for(const k of keys){
    const mn=num(document.getElementById('f-min-'+k).value);
    const mx=num(document.getElementById('f-max-'+k).value);
    if(mn!=null||mx!=null) f[k]=[mn,mx];
  } return f;
}

function applyFilters(){
  state.filters = collectFilters();
  const onlyTransiting = $('#onlyTransiting').checked;
  state.rows = state.all.filter(r=>{
    if(onlyTransiting && r.tran_flag!==1) return false;
    for(const [k,[mn,mx]] of Object.entries(state.filters)){
      const v=r[k]; if(v==null) return false;
      if(mn!=null && v<mn) return false;
      if(mx!=null && v>mx) return false;
    }
    return true;
  });
}

function clearFilters(){
  state.filters={}; document.querySelectorAll('.exo-filters input').forEach(i=>i.value='');
  state.rows = state.all.slice();
}

function buildTraces(){
  const xKey=$('#xSelect').value, yKey=$('#ySelect').value;
  const xFn=PARAMS[xKey], yFn=PARAMS[yKey];
  const colorByTeq=$('#colorTemp').checked;
  const showObs=$('#highlightJWSTObs').checked, showPlan=$('#highlightJWSTPlan').checked;
  const showLabels=$('#showLabels').checked;

  const pop=[], obs=[], plan=[], labelsPop=[], labelsObs=[], labelsPlan=[];
  for(const p of state.rows){
    const x=xFn(p), y=yFn(p); if(x==null||y==null) continue;
    const matchesObs = [...p._nameKeys].some(k => state.jwstObserved.has(k) || state.jwstObserved.has(alphanum(k)));
    const matchesPlan= [...p._nameKeys].some(k => state.jwstPlanned.has(k) || state.jwstPlanned.has(alphanum(k)));
    if(matchesObs){ obs.push({x,y,teq:num(p.pl_eqt)}); if(showLabels) labelsObs.push(p.pl_name); }
    else if(matchesPlan){ plan.push({x,y,teq:num(p.pl_eqt)}); if(showLabels) labelsPlan.push(p.pl_name); }
    else { pop.push({x,y,teq:num(p.pl_eqt)}); if(showLabels) labelsPop.push(p.pl_name); }
  }

  const baseSize=6;
  const sizeByMetric = pts => pts.map(d=>{
    const v = (colorByTeq? d.teq : null);
    return baseSize; // temperature size not used; TSM/ESM sizing would go here if enabled
  });

  const traces=[];
  // Population trace
  const popTrace = {
    name: colorByTeq? 'Population (Teq)' : 'Population',
    type:'scattergl', mode: showLabels?'markers+text':'markers',
    x:pop.map(d=>d.x), y:pop.map(d=>d.y),
    marker: colorByTeq ? {size:baseSize, opacity:.7, color:pop.map(d=>d.teq??NaN), colorscale:'Viridis', showscale:true, colorbar:{title:'Teq (K)'}} : {size:baseSize, opacity:.45, color:'#9CA3AF'},
  };
  if(showLabels) popTrace.text = labelsPop;
  traces.push(popTrace);

  // JWST traces (diamonds). If TSM/ESM sizing exists in your other build, we would integrate it; here we just do size rules.
  if(showPlan){
    const t = { name:'JWST – Planned', type:'scattergl', mode: showLabels?'markers+text':'markers',
      x: plan.map(d=>d.x), y: plan.map(d=>d.y),
      marker:{ size: baseSize*2, opacity:.95, color:'#06b6d4', symbol:'diamond', line:{width:1.5, color:'#034d57'} }
    };
    if(showLabels) t.text = labelsPlan;
    traces.push(t);
  }
  if(showObs){
    const t = { name:'JWST – Observed', type:'scattergl', mode: showLabels?'markers+text':'markers',
      x: obs.map(d=>d.x), y: obs.map(d=>d.y),
      marker:{ size: baseSize*2, opacity:.95, color:'#9370DB', symbol:'diamond', line:{width:1.5, color:'#4b3a8f'} }
    };
    if(showLabels) t.text = labelsObs;
    traces.push(t);
  }
  return traces;
}

function layoutForAxes(){
  const xKey=$('#xSelect').value, yKey=$('#ySelect').value;
  return { margin:{l:60,r:10,t:18,b:50}, xaxis:{title:xKey, type: $('#xLog').checked?'log':'linear', zeroline:false}, yaxis:{title:yKey, type: $('#yLog').checked?'log':'linear', zeroline:false}, legend:{orientation:'h'} };
}

function refresh(){
  const traces = buildTraces();
  Plotly.react('plot', traces, layoutForAxes(), {responsive:true, displaylogo:false});
  const shown = traces.reduce((a,t)=>a+((t.x&&t.x.length)||0),0);
  $('#counts').textContent = `${shown.toLocaleString()} points shown.`;
}

function hookUI(){
  ['xSelect','ySelect','xLog','yLog','colorTemp','onlyTransiting','highlightJWSTObs','highlightJWSTPlan','showLabels']
    .forEach(id=> document.getElementById(id).addEventListener('change', refresh));
  document.getElementById('applyFilters').addEventListener('click', ()=>{ applyFilters(); refresh(); });
  document.getElementById('clearFilters').addEventListener('click', ()=>{ clearFilters(); refresh(); });
  document.querySelectorAll('.exo-chip[data-preset]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      clearFilters();
      const p=btn.dataset.preset, def=PRESETS[p]||{};
      for(const [k,[mn,mx]] of Object.entries(def)){
        document.getElementById('f-min-'+k).value = (mn??'');
        document.getElementById('f-max-'+k).value = (mx??'');
      }
    });
  });
}

function populateDropdowns(){
  const xSel=$('#xSelect'), ySel=$('#ySelect');
  const opts = Object.keys(PARAMS).map(l=>`<option>${l}</option>`).join('');
  xSel.innerHTML = ySel.innerHTML = opts;
  xSel.value='Orbital Period (days)'; ySel.value='Planet Radius (R_⊕)';
}

(async function init(){
  try{
    populateDropdowns(); hookUI();
    const pop = await loadPopulation();
    state.all = pop.slice(); state.rows = pop.slice();
    $('#status').textContent = `Loaded population CSV (rows: ${state.all.length.toLocaleString()})`;
    refresh();
    // Load JWST in background
    await loadJWST();
  }catch(e){
    console.error(e); $('#status').textContent = 'Failed to load local CSVs.';
  }
})();
</script>
